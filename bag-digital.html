<html>

<!--

　　　          ___   .--.
　　　    .--.-"   "-' .- |
　　　   / .-,`          .'   
　　　   \   `           \ 　　　　　　。・゜ 　♡   。　　・　゜ 　　　♡  
　　　    '.            ・ \　　　　　　　　　　　　　　　　　　　　　　　　♡　　　　♡ ゜・。。♡  
　　　      |  ・     ᴥ    。|　　　　・゜♡ ゜・。　　. * ・ ♡ °  . 。
　　　      \ 。            /.____　　　　　　　　　　　　　　　　　　♡.  
　　　     /`-.          ,'.'    `\　　　　　　　　　　　　　　　　　　。・゜　　　 ♡ ・ 。　　。・゜ ♡  
　　　  __/   \`-.____.-' `\      /　　　　　♡　。・゜      
　　　  | `---`'-'._/-`     \----'    _ 　　　　　　　　　　　♡　　　.　　　.♡ 
　　　  |,-'`  /             |    _.-' `\　　　　. * ・        
　　　 .'     /              |--'`     / |　　　　　　　　　　 ♡
　　　/      /\              `         | |
　　　|   .\/  \      .--. __          \ |　　　　　　　　　　　*.。middlepot.com 
　　　 '-'      '._       /  `\         /　　　　　　　　　　　　　　　　　　　　　　　ଘ(*´ ˘ `*)ഒ 。.*
　　　             `\    '     |------'`
　　　               \  |      |
　　　                \        /
 　　　                '._  _.'

-->

<title>shy bunny store ꒱</title>

<head>
<link rel="shortcut icon" href="./img/favicon.png">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="title" content="ꔫ">
<meta name="description" content="shy bunny store ꒱">
<meta name="theme-color" content="#f7e9ed">
<meta name="url" content="https://shybunny.store">
<meta name="identifier-URL" content="https://shybunny.store">
<meta property="og:url" content="https://shybunny.store">
<meta property="og:title" content="ꔫ">
<meta property="og:site_name" content="shybunny.store">
<meta property="og:description" content="shy bunny store ꒱">
<meta property="og:image" content="https://shybunny.store/img/logo.jpg">
<meta property="og:image:type" content="image/jpeg">
<meta property="og:type" content="website">
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://shybunny.store">
<meta property="twitter:title" content="ꔫ">
<meta property="twitter:description" content="shy bunny store ꒱">
<meta property="twitter:image" content="https://shybunny.store/img/logo.jpg">
<meta name="creation_date" content="october 18, 2018">
<meta name="author" content="middlepot, letters@middlepot.com">
<meta name="designer" content="middlepot, letters@middlepot.com">
<meta name="owner" content="middlepot, letters@middlepot.com">
<meta name="copyright" content="poofties © middlepot">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "OnlineStore",
  "name": "shybunny.store",
  "alternateName": "ꔫ",
  "description": "shy bunny store ꒱",
  "url": "https://shybunny.store",
  "logo": "https://shybunny.store/img/logo.jpg",
  "foundingDate": "2018-10-18",
  "identifier": "poofties © middlepot",
  "founder": {
            "@type": "Person",
            "name": "middlepot",
            "email": "letters@middlepot.com",
            "url": "https://middlepot.com",
            "image": "https://middlepot.com/img/melissa.jpg",
            "birthDate": "1997-08-11",
            "jobTitle": "artist, crafter & designer",
            "brand": {
                  "@type": "Brand",
                  "name": "poofties™",
                  "alternateName": "poofties.club",
                  "url": "https://poofties.club",
                  "logo": "https://poofties.club/img/logo.jpg"
                  }
         }
}
</script>


<meta name="google-site-verification" content="oeNF1rwRb131oa5qR8WVVfiQTt36bZAq1i0EVXafmnE" />

<style>
body{ 
  cursor: url(./img/cursor.png), progress;}
a:hover, .hoverable:hover{cursor: url(./img/cursorhover.png), progress;}
 ::selection {text-shadow: 0 0 2px #cec1bb;color:#cec1bb}
 ::-moz-selection {text-shadow: 0 0 2px #cec1bb;color:#cec1bb}
</style>

<style>
	table, tr, td{
		text-align: center;
		font-size: 9pt;
		height: 50px;
		margin: 0;
		padding: 0;
	}
</style>

<style type="text/css">
::-webkit-scrollbar {
width: 5px;
height: 4px;
background: transparent;
}
::-webkit-scrollbar-thumb {
background-color: #fcf7f7;
-webkit-border-radius: 3ex;
border-radius: 3ex;
border: 1px dotted #baaeab;
}
</style>
<style>
html {
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
}

@media screen and (max-width: 1000px) and (orientation: landscape){
#everything { position: absolute; zoom: 85%; left:-100px; top:0px;}
}

@supports not (-webkit-touch-callout: none) {
@media screen and (max-width: 1000px) and (orientation: portrait){
#everything { position: absolute; zoom: 255%;
	left:-350px; top:70px;}
}}
@supports (-webkit-touch-callout: none) {
@media screen and (max-width: 1000px) and (orientation: portrait){
#everything { position: absolute; zoom: 160%;
	left:-350px; top:20px;}
html{-webkit-text-size-adjust: 160%; text-size-adjust: 160%;}
}}

@media screen and (min-width: 1700px) and (orientation: landscape){
#everything { position: absolute; zoom: 120%;
	left:150px;
	top:40px; }
}

@media screen and (min-width: 2000px) and (orientation: landscape){
#everything { position: absolute; zoom: 100%;
	left:-150px; top:10px;}
}

@supports not (-webkit-touch-callout: none) {
@media screen and (max-width: 2000px) and (orientation: portrait){
#everything { position: absolute; zoom: 160%;
	left:-350px; top:20px;}
}}
@supports (-webkit-touch-callout: none) {
@media screen and (max-width: 2000px) and (orientation: portrait){
#everything { position: absolute; zoom: 160%;
	left:-350px; top:20px;}
html{-webkit-text-size-adjust: 160%; text-size-adjust: 160%;}
}}

@media screen and (min-width: 3000px) and (orientation: landscape){
#everything { position: absolute; zoom: 240%;
	left:150px;
	top:40px; }
}
</style>

<script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>
<script src="js/jimp.js"></script>
<script src="js/cookies.js"></script>
<script src="js/store-variables-1.0.js"></script>
<script src="js/util.js"></script>
<script>
	var loadedPaypalSdk = false;
	var loadedMercadopagoSdk = false;
	var buyerCurrency = 'USD';
	var buyerCountry = 'unknown';
	var gotUserLocation = false;
	var brlConversionRate = 4; // 1 USD = 4 BRL
	var affiliateDiscount = 0.05; //5% discount
	async function getBuyerLocation(){
		try{
			var req = await fetch(api_path+'/currency', {method: 'GET'});
			var res = await req.json();
			buyerCurrency = res.currency;
			buyerCountry = res.country;
		}
		catch(err){
			throw err;
		}
		gotUserLocation = true;
	}
	async function loadPaypalSdk(){
		var base_url = 'https://www.paypal.com/sdk/js?client-id=AaJ_j9vf-Z4jI8C7WrbP81WAsXm7HaMGEtFjvostBsdRBze1xJv3DbSX7DasVPtYVar3urkgUhiX3_2Z&components=buttons,funding-eligibility';
		var scrEl = document.createElement('script');
		scrEl.src = base_url;
		scrEl.onload = function(){
			loadedPaypalSdk = true;
		}
		var head = document.head || document.getElementsByTagName("head")[0];
		head.insertBefore(scrEl, head.firstChild);
	}
	async function loadMercadopagoSdk(){
		var scrEl = document.createElement('script');
		scrEl.src = 'https://sdk.mercadopago.com/js/v2';
		scrEl.onload = function(){
			loadedMercadopagoSdk = true;
		}
		var head = document.head || document.getElementsByTagName("head")[0];
		head.insertBefore(scrEl, head.firstChild);
	}

	getBuyerLocation();

	//awaits user location to define which sdk to load
	var awaitingUserLocation = setInterval(function(){
		if(gotUserLocation){
			//if brazil, load mercadopago
			if(buyerCountry === 'BR')
				loadMercadopagoSdk();
			//not brazil, load paypal
			else
				loadPaypalSdk();

			clearInterval(awaitingUserLocation);
		}
	}, 10);
</script>

</head>

<body ondragstart="return false" style="background-image:url(./img/bg.png); background-repeat: repeat; font-family: Calibri; font-size: 11px; letter-spacing:1px; color:#998585; white-space: nowrap;">
<div id="everything">

<script>
	function getCritterType(item){
		for(const [CRITTER] of Object.entries(critters)){
			if(item.critter === critters[CRITTER].NAME){
				return CRITTER;
			}
		}
	}

	//returns the weight of the item
	function getItemWeight(cat){
		for(const [CATEGORY] of Object.entries(categories)){
			if(cat === categories[CATEGORY].CATEGORY){
				return categories[CATEGORY].WEIGHT;
			}
		}
	}

	//returns the weight of ithe item
	function getItemPrice(cat){
		for(const [CATEGORY] of Object.entries(categories)){
			if(cat === categories[CATEGORY].CATEGORY){
				var price = categories[CATEGORY].PRICE_DIGITAL;
				if(loadedMercadopagoSdk)
					price *= brlConversionRate;

				return price;
			}
		}
	}

	//iterate over cart to evaluate price
	function calculateItemsPrice(){
		var finalPrice = 0;
		cart_items.forEach(item =>{
			if(item){
				finalPrice += getItemPrice(item.category);
			}
		});
		return finalPrice;
	}

	async function calculateFinalPrice(){
		var currency = (loadedPaypalSdk?' usd':' reais');
		//gets final price
		var total = calculateItemsPrice();
		var accumulatedDiscount = appliedDiscount/100;
		//check if affiliate exists
		var affCode = getQueryParam(affiliateParam);
		var affValid = false;
		if(affCode){
			try{
				var affReq = await fetch(api_path+'/order/affiliate/exists?affiliate='+affCode);
				if(affReq.status === 200){
					accumulatedDiscount += affiliateDiscount;
					affValid = true;
				}
			}
			catch(err){
				console.log('could not evaluate affiliate '+affCode);
				console.log(err);
			}
		}
		var totalDiscounted = total*(1-accumulatedDiscount);
		var totalFloat = parseFloat(total);
		var totalDiscountedFloat = parseFloat(totalDiscounted);
		if(totalDiscountedFloat % 1 !== 0)
			totalDiscountedFloat = totalDiscountedFloat.toFixed(2);
		
		var totalEl = document.getElementById('grand-total');
		if(!affValid && (!appliedDiscount || appliedDiscount <= 0)){
			totalEl.innerHTML = (loadedMercadopagoSdk?'R':'')+'$ '+totalFloat+currency;
			return totalFloat;
		}
		else{
			totalEl.innerHTML = (loadedMercadopagoSdk?'R':'')+'$ <span style="text-decoration: line-through;">'+totalFloat+'</span> '+totalDiscountedFloat+currency;
			return parseFloat(totalDiscounted);
		}
	}
	
	function cartIsEmpty(){
		return (!cart_items || cart_items.length <= 0)
	}
	
	async function removeFromCart(){
		var clicked = $(this).closest('td').parent()[0].sectionRowIndex;
		if(clicked >= 0){
			cart_items.splice(clicked, 1);
			setCookie("cart_items", JSON.stringify(cart_items));
			await updateCart();
		}
	}
	
	async function updateCart(){
		//pomisify jimp image creation
		var JimpCreate = (w, h) => new Promise((resolve) => {new Jimp(w, h, function(err, img){resolve(img);})});
		var prevEl = document.getElementById('table-preview');
		var quantEl = document.getElementById('table-quantity');
		var tr, td;
		//clear tables
		document.getElementById('table-remove').innerHTML = '';
		document.getElementById('table-preview').innerHTML = '';
		document.getElementById('table-price').innerHTML = '';
		document.getElementById('table-quantity').innerHTML = '';
		if(!cart_items || cart_items.length <= 0){
			if(mercadopagostatus !== 'approved' && mercadopagostatus !== 'pending'){
				document.getElementById('tables').style.display = 'none';
				document.getElementById('bag-state').src = 'img/bagempty.png';
				document.getElementById('buyermail').remove();
				document.getElementById('coupon').remove();
				document.getElementById('emailvalidator').remove();
				document.getElementById('grand-total').remove();
				document.getElementById('coupon-status').remove();
			}
		}
		else{
			document.getElementById('tables').style.display = 'block';
			document.getElementById('bag-state').src = 'img/bagfull-digital.png';
			for(var i = 0; i < cart_items.length; ++i){
				var item = cart_items[i];
				//remove
				tr = document.createElement('tr');
				td = document.createElement('td');
				var img = document.createElement('img');
				img.src = 'img/bagdelete.png';
				img.classList.add('hoverable');
				img.onclick = removeFromCart;
				td.appendChild(img);
				tr.appendChild(td);
				document.getElementById('table-remove').appendChild(tr);
				//create preview
				var critterType = getCritterType(item);
				var jimg;
				var bgBoxSize = 50;
				var baseOffset = 10;
				//critter
				var jimg, jbody, jhead, jarm;
				var jimgprom = JimpCreate(300, 340).then(img => jimg = img);
				var bodyprom = Jimp.read(critters[critterType].BODY).then(img => jbody = img);
				var armprom = Jimp.read(critters[critterType].ARMS[item.variation]).then(img => jarm = img);
				var headprom = Jimp.read(critters[critterType].HEAD).then(img => jhead = img);
				await Promise.all([jimgprom, bodyprom, headprom, armprom]);
				//makes critter
				jimg.composite(jbody, baseOffset, baseOffset);
				if(item.accessory >= 0 && item.accessory < critters[critterType].ACCESSORIES.length){
					//load accessory
					var acc = critters[critterType].ACCESSORIES[item.accessory];
					var jacc = await Jimp.read(acc.IMG);
					//if arm is behind accessory
					if(!critters[critterType].ACCESSORIES[item.accessory].BEHIND_ARMS[item.variation]){
						if(item.variation === 2) //this arm is above face
							jimg.composite(jhead, baseOffset, baseOffset);
						jimg.composite(jarm, baseOffset, baseOffset);
						if(item.variation < 2) //this arm is below face
							jimg.composite(jhead, baseOffset, baseOffset);
						//accessory
						jimg.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
					}
					else{
						//arm above accessory
						if(item.variation === 2){ //this arm is above face
							jimg.composite(jhead, baseOffset, baseOffset);
							jimg.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
						}
						jimg.composite(jarm, baseOffset, baseOffset);
						if(item.variation < 2){ //this arm is below face
							jimg.composite(jhead, baseOffset, baseOffset);
							jimg.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
						}
					}
				}
				else{
					//there are no accessories
					if(item.variation === 2) //this arm is above face
						jimg.composite(jhead, baseOffset, baseOffset);
					jimg.composite(jarm, baseOffset, baseOffset);
					if(item.variation < 2) //this arm is below face
						jimg.composite(jhead, baseOffset, baseOffset);
				}
				jimg.autocrop();
				jimg.scaleToFit(bgBoxSize*0.8, bgBoxSize*0.8);
				//applies bg and converts to base64
				var bg = await Jimp.read('img/bagbox.png');
				bg.composite(jimg, bg.bitmap.width/2-jimg.bitmap.width/2, (bg.bitmap.height-jimg.bitmap.height)/2);
				bg.getBase64Async(Jimp.MIME_PNG)
				.then(bg64 =>{
					tr = document.createElement('tr');
					td = document.createElement('td');
					img = document.createElement('img');
					img.src = bg64;
					img.name = 'item-preview';
					td.appendChild(img);
					tr.appendChild(td);
					document.getElementById('table-preview').appendChild(tr);
				});
				//price
				tr = document.createElement('tr');
				td = document.createElement('td');
				td.innerHTML = (loadedMercadopagoSdk?'R':'')+'$'+getItemPrice(item.category);
				tr.appendChild(td);
				document.getElementById('table-price').appendChild(tr);
				//quantity
				tr = document.createElement('tr');
				td = document.createElement('td');
				td.innerHTML = 1;
				tr.appendChild(td);
				document.getElementById('table-quantity').appendChild(tr);
			}
			//sets final price
			await calculateFinalPrice();
		}
	}

	function clearCart(){
		setCookie("cart_items", JSON.stringify([]));
		deleteCookie("cart_items");
	}

	//load cart from cookies
	async function loadCart(){
		if(!loadingSomething && (loadedMercadopagoSdk || loadedPaypalSdk)){
			var cartCookie = getCookie("cart_items");
			if(cartCookie){
				var cart = JSON.parse(cartCookie);
				if(Array.isArray(cart) && cart.length > 0){
					cart_items = cart;
				}
			}
			await updateCart();
		}
		else{
			setTimeout(loadCart, 50);
		}
	}

	var oldCouponCode = '';
	var appliedDiscount = 0;
	async function checkCoupon(){
		var couponEl = document.getElementById('coupon');
		var code = couponEl.value;
		var statusEl = document.getElementById('coupon-status');
		if(code){
			oldCouponCode = code;
			var req = await fetch(api_path+'/coupon?code='+code, {method: 'GET'});
			var res = await req.json();
			if(res && !isNaN(res) && res > 0){
				statusEl.style.display = 'block';
				statusEl.src = 'img/couponok.png';
				appliedDiscount = res;
			}
			else{
				statusEl.style.display = 'block';
				statusEl.src = 'img/couponwrong.png';
				appliedDiscount = 0;
			}
		}
		else if(oldCouponCode){
			statusEl.style.display = 'block';
			statusEl.src = 'img/couponwrong.png';
			appliedDiscount = 0;
		}
		await calculateFinalPrice();
	}
</script>

<img style="position: absolute;
	left: 340px;
	top: 20px;
overflow-y:hidden;
overflow-x:hidden;
z-index: 1;" src="./img/digitalbag.png">

<a href="/policies">
<img style="position: absolute;
	left: 350px;
	top: 450px;
overflow-y:hidden;
overflow-x:hidden;
z-index: 2;" src="./img/privacybutton.png"></a>

<a href="/">
<img style="position: absolute;
	left: 365px;
	top: 485px;
overflow-y:hidden;
overflow-x:hidden;
z-index: 2;" src="./img/homeleft.png"></a>

<img id="bag-state" style="position: absolute;
	left: 475px;
	top: 165px;
overflow-y:hidden;
overflow-x:hidden;
z-index: 2;" src="./img/bagfull-digital.png">

<div id="tables" style="position: absolute; left: 450px; top: 190px;
overflow: auto; overflow: scroll; z-index: 5; width:370px; height:175px;
background: transparent; resize: none; outline:none;
border: 0px; color: #917979; font-family: Calibri;
font-size: 11px; letter-spacing:1px; line-height:20px;">

<div style="position: absolute; left:10px; right:10px;">
	<div style="display: flex;">
		<table id="table-remove" style="position: relative;"></table>
		<table id="table-preview" style="position: relative;"></table>
		<table id="table-quantity" style="position: relative; left: 30px;"></table>
		<table id="table-price" style="position: relative; left: 72px;"></table>
	</div>
</div>

</div>

<p id="grand-total" style="font-size: 11pt; font-weight: bold; text-align: right; position: absolute; top: 475px; left: 530px; z-index: 20;"></p>

<style>
::placeholder { color:#bda4a4; opacity: 1; }
::-ms-input-placeholder { color:#bda4a4; opacity: 1; }
</style>

<input id="buyermail" maxlength="50" style="position: absolute; left: 620px; top: 413px;
overflow: hidden; z-index: 5; width: 155px; height:20px;
background: transparent; resize: none; padding:5px; outline:none;
border: 0px; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;" oninput="validateEmail(this.value);"></input>

<img id="emailvalidator" style="display: none; z-index: 20; position: absolute; top: 420px; left: 785px;">

<input id="coupon" maxlength="8" style="position: absolute; left: 638px; top: 456px;
overflow: hidden; z-index: 5; width: 65px; height:20px;
background: transparent; resize: none; padding:5px; outline:none;
border: 0px; cursor: url(./img/cursorwrite.png), progress; color: #fff; font-family: Calibri;
font-size: 11px; letter-spacing:1px; line-height:15px; font-weight:bold;" onblur="checkCoupon();"></input>

<img id="coupon-status" style="display: none; z-index: 20; position: absolute; top: 458px; left: 715px;">

<img id="bag-total" style="position: absolute;
	left: 475px;
	top: 410px;
overflow-y:hidden;
overflow-x:hidden;
z-index: 2;" src="./img/bagtotal.png">

<img id="notebag" src="./img/notebag.png" style="position: absolute; z-index: 2; top: 565px; left: 685px;">

<!-- Add the checkout buttons, set up the order and approve the order -->
<div id="paypal-payment-methods">
	<img src="./img/checkoutback.png" style="position: absolute; z-index: 2; top: 525px; left: 485px;">
	<img src="./img/checkoutpaypal.png" style="pointer-events: none; position: absolute; z-index: 4; top: 529px; left: 489px;">
	<img src="./img/checkoutcredit.png" style="pointer-events: none; position: absolute; z-index: 4; top: 574px; left: 489px;">
</div>
<div id="paypal-container" style="z-index: 3; width: 175px; position: absolute; top: 530px; left: 490px;">
	<div class="hoverable" id="paypal-button-container"></div>
	<div class="hoverable" id="card-button-container" style="margin-top: 5px;"></div>
</div>
<div id="mercadopago-container" style="display: none;">
	<a><img src="./img/brazilcheckout.png" id="mercadopago-button" onclick="openMercadopago();" style="position: absolute; z-index: 4; top: 529px; left: 489px;"></a>
</div>
<script>
	var paypalButtons = [];
	var buyerCardRestricted = false;
	function loadPaypalButtons(){
		if(loadedPaypalSdk){
			var FUNDING_SOURCES = [
				paypal.FUNDING.PAYPAL
			];
			//check buyer country to determine available payment
			var cardRestrictedCountries = ['BR', 'JP', 'RU'];
			buyerCardRestricted = cardRestrictedCountries.includes(buyerCountry);
			if(!buyerCardRestricted){
				//enable card payment
				FUNDING_SOURCES.push(paypal.FUNDING.CARD);
			}
			//restricted
			else{
				var el = $(`<img src="./img/jprussiacheckout.png" style="pointer-events: none; position: absolute; z-index: 4; top: 524px; left: 485px;">`);
				$('#paypal-payment-methods').empty().append(el);
				$('#notebag')[0].src = './img/jprussianotebag.png';
			}

			// Loop over each funding source/payment method
			FUNDING_SOURCES.forEach(function(fundingSource) {
				// Initialize the buttons
				var divContainer = fundingSource === paypal.FUNDING.PAYPAL?'#paypal-button-container':'#card-button-container';
				var button = paypal.Buttons({
					fundingSource: fundingSource,
					style:{
						tagline: false,
						height: 40
					},
					createOrder: async function (data, actions) {
						var catcart = [];
						cart_items.forEach(item =>{
							catcart.push(item.category);
						});
						var code = document.getElementById('coupon').value;
						var priceFetch = await fetch(api_path+'/order/price?digital=true', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								cart: catcart,
								coupon: code,
								affiliate: getQueryParam(affiliateParam)
							})
						});
						var resp = await priceFetch.json();
						updatedPrice = resp.price.price;
						var convReq = await fetch(api_path+'/currency/conversion?amt='+updatedPrice, {method: 'GET'});
						var convRes = await convReq.json();
						var currency = convRes.currency;
						var finalValue = convRes.amount;
						return actions.order.create({
							purchase_units: [{
								amount: {
									value: finalValue,
									currency_code: currency
								}
							}]
						});
					},
					onClick: function(){
						var buyerMailEl = document.getElementById('buyermail');
						var buyerMail = buyerMailEl.value;
						if(!validateEmail(buyerMail)){
							//invalid email
							buyerMailEl.value = '';
							return false;
						}
					},
					onApprove: function (data, actions) {
						return actions.order.capture().then(async function (details) {
							var buyerMailEl = document.getElementById('buyermail');
							var buyerMail = buyerMailEl.value;
							var couponEl = document.getElementById('coupon');
							var usedCoupon = couponEl.value;
							var previews = document.getElementsByName('item-preview');
							var formData = JSON.stringify({
								orderId: details.id,
								buyerMail: buyerMail,
								coupon: usedCoupon,
								affiliate: getQueryParam(affiliateParam),
								items: cart_items
							});

							//change page layout
							document.getElementById('tables').style.display = 'none';
							document.getElementById('bag-state').src = 'img/bagdone-digital.png';
							document.getElementById('buyermail').remove();
							document.getElementById('coupon').remove();
							document.getElementById('emailvalidator').remove();
							document.getElementById('grand-total').remove();
							document.getElementById('coupon-status').remove();

							return fetch(api_path+'/order/digital', {
								method: 'POST',
								cache: 'no-cache',
								headers:{
									'Content-Type': 'application/json'
								},
								body: formData
							}).then(()=>{
								clearCart();
								paypalButtons.forEach(btn => btn.close());
							});
						});
					},
					onError: function(err){
						location.reload();
					}
				});
				// Check if the button is eligible
				if(button.isEligible()){
					// Render the standalone button for that funding source
					paypalButtons.push(button);
					button.render(divContainer);
				}
			});
		}
		else if(!loadedMercadopagoSdk){
			//await paypal sdk to load, if needed
			setTimeout(loadPaypalButtons, 50);
		}
	}
	
	var mercadopago;
	var mercadopagoCheckout;
	var mercadopagostatus = getQueryParam('mercadopago_status');
	function loadMercadopagoButtons(){
		if(loadedMercadopagoSdk){
			
			//hide paypal containers and show mercadopago
			document.getElementById('paypal-payment-methods').style.display = 'none';
			document.getElementById('paypal-container').style.display = 'none';
			document.getElementById('mercadopago-container').style.display = 'block';
			document.getElementById('mercadopago-button').style.display = 'block';
			document.getElementById('notebag').src = './img/brazilnotebag.png';

			//check if came redirected from mercadopago
			if(mercadopagostatus === 'approved' || mercadopagostatus === 'pending'){
				clearCart();
				//show 'done' message
				document.getElementById('tables').style.display = 'none';
				document.getElementById('bag-state').src = 'img/bagdone-digital.png';
				document.getElementById('buyermail').remove();
				document.getElementById('coupon').remove();
				document.getElementById('emailvalidator').remove();
				document.getElementById('grand-total').remove();
				document.getElementById('coupon-status').remove();
			}

			mercadopago = new MercadoPago('APP_USR-6039baf3-61e2-45ee-bc85-b6c9e0cba763', {
				locale: 'pt-BR'
			});
		}
		else if(!loadedPaypalSdk){
			//await paypal sdk to load, if needed
			setTimeout(loadMercadopagoButtons, 10);
		}
	}
	async function openMercadopago(){

		var buyerMailEl = document.getElementById('buyermail');
		var buyerMail = buyerMailEl.value;
		if(!validateEmail(buyerMail)){
			//invalid email
			buyerMailEl.value = '';
			return false;
		}
		
		showLoadingOverlay();

		//parse cart
		var catcart = [];
		cart_items.forEach(item =>{
			catcart.push(item.category);
		});

		//init checkout
		var prefId;
		try{
			var req = await fetch(api_path+'/order/mercadopago/preference/create?digital=true',{
				method: 'POST',
				headers:{
					'content-type': 'application/json'
				},
				body: JSON.stringify({
					cart: catcart,
					rawcart: cart_items,
					email: document.getElementById('buyermail').value,
					coupon: document.getElementById('coupon').value,
					affiliate: getQueryParam(affiliateParam)
				})
			});
			if(req.status === 200){
				var body = await req.json();
				prefId = body.preference;
			}
			//create and open checkout
			mercadopagoCheckout = await mercadopago.checkout({
				preference:{
					id: prefId
				}
			});
			mercadopagoCheckout.open();
		}
		catch(err){
			console.log(err);
		}
		hideLoadingOverlay();
	}

	loadPaypalButtons();
	loadMercadopagoButtons();
</script>

<script>loadCart();</script>

</div>
</body>

<!--

　　　          ___   .--.
　　　    .--.-"   "-' .- |
　　　   / .-,`          .'   
　　　   \   `           \ 　　　　　　。・゜ 　♡   。　　・　゜ 　　　♡  
　　　    '.            ・ \　　　　　　　　　　　　　　　　　　　　　　　　♡　　　　♡ ゜・。。♡  
　　　      |  ・     ᴥ    。|　　　　・゜♡ ゜・。　　. * ・ ♡ °  . 。
　　　      \ 。            /.____　　　　　　　　　　　　　　　　　　♡.  
　　　     /`-.          ,'.'    `\　　　　　　　　　　　　　　　　　　。・゜　　　 ♡ ・ 。　　。・゜ ♡  
　　　  __/   \`-.____.-' `\      /　　　　　♡　。・゜      
　　　  | `---`'-'._/-`     \----'    _ 　　　　　　　　　　　♡　　　.　　　.♡ 
　　　  |,-'`  /             |    _.-' `\　　　　. * ・        
　　　 .'     /              |--'`     / |　　　　　　　　　　 ♡
　　　/      /\              `         | |
　　　|   .\/  \      .--. __          \ |　　　　　　　　　　　*.。middlepot.com 
　　　 '-'      '._       /  `\         /　　　　　　　　　　　　　　　　　　　　　　　ଘ(*´ ˘ `*)ഒ 。.*
　　　             `\    '     |------'`
　　　               \  |      |
　　　                \        /
 　　　                '._  _.'

-->

</html>