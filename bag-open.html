<html>

<!--

　　　          ___   .--.
　　　    .--.-"   "-' .- |
　　　   / .-,`          .'   
　　　   \   `           \ 　　　　　　。・゜ 　♡   。　　・　゜ 　　　♡  
　　　    '.            ・ \　　　　　　　　　　　　　　　　　　　　　　　　♡　　　　♡ ゜・。。♡  
　　　      |  ・     ᴥ    。|　　　　・゜♡ ゜・。　　. * ・ ♡ °  . 。
　　　      \ 。            /.____　　　　　　　　　　　　　　　　　　♡.  
　　　     /`-.          ,'.'    `\　　　　　　　　　　　　　　　　　　。・゜　　　 ♡ ・ 。　　。・゜ ♡  
　　　  __/   \`-.____.-' `\      /　　　　　♡　。・゜      
　　　  | `---`'-'._/-`     \----'    _ 　　　　　　　　　　　♡　　　.　　　.♡ 
　　　  |,-'`  /             |    _.-' `\　　　　. * ・        
　　　 .'     /              |--'`     / |　　　　　　　　　　 ♡
　　　/      /\              `         | |
　　　|   .\/  \      .--. __          \ |　　　　　　　　　　　*.。middlepot.com 
　　　 '-'      '._       /  `\         /　　　　　　　　　　　　　　　　　　　　　　　ଘ(*´ ˘ `*)ഒ 。.*
　　　             `\    '     |------'`
　　　               \  |      |
　　　                \        /
 　　　                '._  _.'

-->

<title>shy bunny store ꒱</title>

<head>
<link rel="shortcut icon" href="./img/favicon.png">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="title" content="ꔫ">
<meta name="description" content="shy bunny store ꒱">
<meta name="theme-color" content="#f7e9ed">
<meta name="url" content="https://shybunny.store">
<meta name="identifier-URL" content="https://shybunny.store">
<meta property="og:url" content="https://shybunny.store">
<meta property="og:title" content="ꔫ">
<meta property="og:site_name" content="shybunny.store">
<meta property="og:description" content="shy bunny store ꒱">
<meta property="og:image" content="https://shybunny.store/img/logo.jpg">
<meta property="og:image:type" content="image/jpeg">
<meta property="og:type" content="website">
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://shybunny.store">
<meta property="twitter:title" content="ꔫ">
<meta property="twitter:description" content="shy bunny store ꒱">
<meta property="twitter:image" content="https://shybunny.store/img/logo.jpg">
<meta name="creation_date" content="october 18, 2018">
<meta name="author" content="middlepot, letters@middlepot.com">
<meta name="designer" content="middlepot, letters@middlepot.com">
<meta name="owner" content="middlepot, letters@middlepot.com">
<meta name="copyright" content="poofties © middlepot">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "OnlineStore",
  "name": "shybunny.store",
  "alternateName": "ꔫ",
  "description": "shy bunny store ꒱",
  "url": "https://shybunny.store",
  "logo": "https://shybunny.store/img/logo.jpg",
  "foundingDate": "2018-10-18",
  "identifier": "poofties © middlepot",
  "founder": {
            "@type": "Person",
            "name": "middlepot",
            "email": "letters@middlepot.com",
            "url": "https://middlepot.com",
            "image": "https://middlepot.com/img/melissa.jpg",
            "birthDate": "1997-08-11",
            "jobTitle": "artist, crafter & designer",
            "brand": {
                  "@type": "Brand",
                  "name": "poofties™",
                  "alternateName": "poofties.club",
                  "url": "https://poofties.club",
                  "logo": "https://poofties.club/img/logo.jpg"
                  }
         }
}
</script>


<meta name="google-site-verification" content="oeNF1rwRb131oa5qR8WVVfiQTt36bZAq1i0EVXafmnE" />

<style>
body{ 
  cursor: url(./img/cursor.png), progress;}
a:hover, .hoverable:hover{cursor: url(./img/cursorhover.png), progress;}
 ::selection {text-shadow: 0 0 2px #cec1bb;color:#cec1bb}
 ::-moz-selection {text-shadow: 0 0 2px #cec1bb;color:#cec1bb}
</style>

<style>
	table, tr, td{
		text-align: center;
		font-size: 9pt;
		height: 50px;
		margin: 0;
		padding: 0;
	}
</style>

<style type="text/css">
::-webkit-scrollbar {
width: 5px;
height: 4px;
background: transparent;
}
::-webkit-scrollbar-thumb {
background-color: #fcf7f7;
-webkit-border-radius: 3ex;
border-radius: 3ex;
border: 1px dotted #baaeab;
}
</style>
<style>
html {
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
}

@media screen and (max-width: 1000px) and (orientation: landscape){
#everything { position: absolute; zoom: 85%; left:-100px; top:0px;}
}

@supports not (-webkit-touch-callout: none) {
@media screen and (max-width: 1000px) and (orientation: portrait){
#everything { position: absolute; zoom: 255%;
	left:-350px; top:70px;}
}}
@supports (-webkit-touch-callout: none) {
@media screen and (max-width: 1000px) and (orientation: portrait){
#everything { position: absolute; zoom: 160%;
	left:-350px; top:20px;}
html{-webkit-text-size-adjust: 160%; text-size-adjust: 160%;}
}}

@media screen and (min-width: 1700px) and (orientation: landscape){
#everything { position: absolute; zoom: 120%;
	left:150px;
	top:40px; }
}

@media screen and (min-width: 2000px) and (orientation: landscape){
#everything { position: absolute; zoom: 100%;
	left:-150px; top:10px;}
}

@supports not (-webkit-touch-callout: none) {
@media screen and (max-width: 2000px) and (orientation: portrait){
#everything { position: absolute; zoom: 160%;
	left:-350px; top:20px;}
}}
@supports (-webkit-touch-callout: none) {
@media screen and (max-width: 2000px) and (orientation: portrait){
#everything { position: absolute; zoom: 160%;
	left:-350px; top:20px;}
html{-webkit-text-size-adjust: 160%; text-size-adjust: 160%;}
}}

@media screen and (min-width: 3000px) and (orientation: landscape){
#everything { position: absolute; zoom: 240%;
	left:150px;
	top:40px; }
}
</style>

<script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>
<script src="js/jimp.js"></script>
<script src="js/cookies.js"></script>
<script src="js/store-variables-1.0.js"></script>
<script src="js/util.js"></script>
<script>
	function openDigitalConfirmation(){
		var whiteoverlay = document.createElement('div');
		whiteoverlay.id = 'digitalConfirmationOverlay';
		whiteoverlay.style.position = 'fixed';
		whiteoverlay.style.display = 'flex';
		whiteoverlay.style.justifyContent = 'center';
		whiteoverlay.style.alignItems = 'center';
		whiteoverlay.style.width = '100%';
		whiteoverlay.style.height = '100%';
		whiteoverlay.style.top = '0';
		whiteoverlay.style.left = '0';
		whiteoverlay.style.background = 'rgba(255, 255, 255, 0.3)';
		whiteoverlay.style.zIndex = '999990';
		$(whiteoverlay).insertAfter('head');

		var warning = document.createElement('img');
		warning.id = 'digitalConfirmationMessage';
		warning.src = './img/digital-info.png';
		warning.style.position = 'absolute';
		warning.style.display = 'block';
		warning.style.top = '120px';
		warning.style.left = '450px';
		warning.style.zIndex = '999991';
		$('#everything').append(warning);

		var yesa = document.createElement('a');
		yesa.id = 'digitalConfirmationConfirm';
		yesa.href = '/bag-digital';
		yesa.style.position = 'absolute';
		yesa.style.display = 'block';
		yesa.style.top = '570px';
		yesa.style.left = '645px';
		yesa.style.zIndex = '999992';
		var yes = document.createElement('img');
		yes.src = './img/yes-digital.png';
		yesa.appendChild(yes);
		$('#everything').append(yesa);

		var close = document.createElement('img');
		close.id = 'digitalConfirmationClose';
		close.src = './img/bagdelete.png';
		close.style.position = 'absolute';
		close.style.display = 'block';
		close.style.top = '130px';
		close.style.left = '775px';
		close.style.zIndex = '999992';
		close.onclick = function(){
			$('#digitalConfirmationOverlay')[0].remove();
			$('#digitalConfirmationMessage')[0].remove();
			$('#digitalConfirmationClose')[0].remove();
			$('#digitalConfirmationConfirm')[0].remove();
		}
		$('#everything').append(close);
	}

	function showShippingWarning(){
		var whiteoverlay = document.createElement('div');
		whiteoverlay.id = 'shippingWarningOverlay';
		whiteoverlay.style.position = 'fixed';
		whiteoverlay.style.display = 'flex';
		whiteoverlay.style.justifyContent = 'center';
		whiteoverlay.style.alignItems = 'center';
		whiteoverlay.style.width = '100%';
		whiteoverlay.style.height = '100%';
		whiteoverlay.style.top = '0';
		whiteoverlay.style.left = '0';
		whiteoverlay.style.background = 'rgba(255, 255, 255, 0.3)';
		whiteoverlay.style.zIndex = '999990';
		$(whiteoverlay).insertAfter('head');

		var warning = document.createElement('img');
		warning.id = 'shippingWarningMessage';
		warning.src = './img/shippingwarning.png';
		warning.style.position = 'absolute';
		warning.style.display = 'block';
		warning.style.top = '190px';
		warning.style.left = '500px';
		warning.style.zIndex = '999991';
		$('#everything').append(warning);

		var close = document.createElement('img');
		close.id = 'shippingWarningClose';
		close.src = './img/bagdelete.png';
		close.style.position = 'absolute';
		close.style.display = 'block';
		close.style.top = '200px';
		close.style.left = '720px';
		close.style.zIndex = '999992';
		close.onclick = function(){
			$('#shippingWarningOverlay')[0].remove();
			$('#shippingWarningMessage')[0].remove();
			$('#shippingWarningClose')[0].remove();
		}
		$('#everything').append(close);
	}

	var loadedPaypalSdk = false;
	var loadedMercadopagoSdk = false;
	var buyerCurrency = 'USD';
	var buyerCountry = 'unknown';
	var gotUserLocation = false;
	var brlConversionRate = 4; // 1 USD = 4 BRL
	var affiliateDiscount = 0.05; //5% discount
	async function getBuyerLocation(){
		try{
			var req = await fetch(api_path+'/currency', {method: 'GET'});
			var res = await req.json();
			buyerCurrency = res.currency;
			buyerCountry = res.country;
		}
		catch(err){
			throw err;
		}
		gotUserLocation = true;
	}
	async function loadPaypalSdk(){
		var base_url = `https://www.paypal.com/sdk/js?client-id=${paypalKey}&components=buttons,funding-eligibility`;
		var scrEl = document.createElement('script');
		scrEl.src = base_url;
		scrEl.onload = function(){
			loadedPaypalSdk = true;
		}
		var head = document.head || document.getElementsByTagName("head")[0];
		head.insertBefore(scrEl, head.firstChild);

		//check if must show warning
		var shippingRestricted = ['ZA', 'AU', 'NZ', 'PH', 'ID'];
		if(buyerCountry === 'unknown' || shippingRestricted.includes(buyerCountry)){
			showShippingWarning();
		}
	}
	async function loadMercadopagoSdk(){
		var scrEl = document.createElement('script');
		scrEl.src = 'https://sdk.mercadopago.com/js/v2';
		scrEl.onload = function(){
			loadedMercadopagoSdk = true;
		}
		var head = document.head || document.getElementsByTagName("head")[0];
		head.insertBefore(scrEl, head.firstChild);
	}

	getBuyerLocation();

	//awaits user location to define which sdk to load
	var awaitingUserLocation = setInterval(function(){
		if(gotUserLocation){
			//if brazil, load mercadopago
			if(buyerCountry === 'BR')
				loadMercadopagoSdk();
			//not brazil, load paypal
			else
				loadPaypalSdk();

			clearInterval(awaitingUserLocation);
		}
	}, 10);
</script>

</head>

<body ondragstart="return false" style="background-image:url(./img/bg.png); background-repeat: repeat; font-family: Calibri; font-size: 11px; letter-spacing:1px; color:#998585; white-space: nowrap;">
<div id="everything">

<script>
	function getCritterType(item){
		for(const [CRITTER] of Object.entries(critters)){
			if(item.critter === critters[CRITTER].NAME){
				return CRITTER;
			}
		}
	}

	//returns the weight of ithe item
	function getItemWeight(cat){
		for(const [CATEGORY] of Object.entries(categories)){
			if(cat === categories[CATEGORY].CATEGORY){
				return categories[CATEGORY].WEIGHT;
			}
		}
	}

	//returns the weight of ithe item
	function getItemPrice(cat){
		for(const [CATEGORY] of Object.entries(categories)){
			if(cat === categories[CATEGORY].CATEGORY){
				var price = categories[CATEGORY].PRICE;
				if(loadedMercadopagoSdk)
					price *= brlConversionRate;

				return price;
			}
		}
	}

	//iterate over cart to evaluate shipping
	function calculateShipping(){
		var packagePrice = 5;
		var packageMaxWeight = 50;
		var finalPrice = 0;
		var packageCount = 1;
		var insidePackage = 0;
		cart_items.forEach(item =>{
			if(item){
				for(const [ITEM] of Object.entries(categories)){
					if(item.category === categories[ITEM].CATEGORY){
						insidePackage += categories[ITEM].WEIGHT;
						if(insidePackage > packageMaxWeight){
							insidePackage = categories[ITEM].WEIGHT;
							packageCount += 1;
						}
						break;
					}
				}
			}
		});
		if(packageCount >= 5)
			finalPrice += 30; //30usd for a box
		else
			finalPrice = (packagePrice*packageCount);
		//charging in BRL
		if(loadedMercadopagoSdk)
			finalPrice *= brlConversionRate;

		var mode = packageCount+' package';
		if(packageCount > 1)
			mode += 's';
		var boxes = Math.floor(packageCount/5);
		if(boxes > 0){
			mode = '1 box';
		}
		return {total: finalPrice, mode: mode};
	}

	//iterate over cart to evaluate price
	function calculateItemsPrice(){
		var finalPrice = 0;
		cart_items.forEach(item =>{
			if(item){
				finalPrice += getItemPrice(item.category);
			}
		});
		return finalPrice;
	}

	async function calculateFinalPrice(){
		var currency = (loadedPaypalSdk?' usd':' reais');
		//sets shipping fee
		var shipping = calculateShipping();
		var shippingEl = document.getElementById('shipping-total');
		shippingEl.innerHTML = (loadedMercadopagoSdk?'R':'')+'$ '+shipping.total+currency+' ( ' + shipping.mode + ' )';
		//gets final price
		var total = (calculateItemsPrice()+shipping.total);
		var accumulatedDiscount = appliedDiscount/100;
		//check if affiliate exists
		var affCode = getQueryParam(affiliateParam);
		var affValid = false;
		if(affCode){
			try{
				var affReq = await fetch(api_path+'/order/affiliate/exists?affiliate='+affCode);
				if(affReq.status === 200){
					accumulatedDiscount += affiliateDiscount;
					affValid = true;
				}
			}
			catch(err){
				console.log('could not evaluate affiliate '+affCode);
				console.log(err);
			}
		}
		var totalDiscounted = total*(1-accumulatedDiscount);
		var totalFloat = parseFloat(total);
		var totalDiscountedFloat = parseFloat(totalDiscounted);
		if(totalDiscountedFloat % 1 !== 0)
			totalDiscountedFloat = totalDiscountedFloat.toFixed(2);
		
		var totalEl = document.getElementById('grand-total');
		if(!affValid && (!appliedDiscount || appliedDiscount <= 0)){
			totalEl.innerHTML = (loadedMercadopagoSdk?'R':'')+'$ '+totalFloat+currency;
			return totalFloat;
		}
		else{
			totalEl.innerHTML = (loadedMercadopagoSdk?'R':'')+'$ <span style="text-decoration: line-through;">'+totalFloat+'</span> '+totalDiscountedFloat+currency;
			return parseFloat(totalDiscounted);
		}
	}
	
	function cartIsEmpty(){
		return (!cart_items || cart_items.length <= 0)
	}
	
	async function removeFromCart(){
		var clicked = $(this).closest('td').parent()[0].sectionRowIndex;
		if(clicked >= 0){
			cart_items.splice(clicked, 1);
			setCookie("cart_items", JSON.stringify(cart_items));
			await updateCart();
		}
	}
	
	async function updateCart(){
		//pomisify jimp image creation
		var JimpCreate = (w, h) => new Promise((resolve) => {new Jimp(w, h, function(err, img){resolve(img);})});
		var prevEl = document.getElementById('table-preview');
		var typeEl = document.getElementById('table-type');
		var quantEl = document.getElementById('table-quantity');
		var weightEl = document.getElementById('table-weight');
		var totalWeight = 0;
		var tr, td;
		//clear tables
		document.getElementById('table-remove').innerHTML = '';
		document.getElementById('table-preview').innerHTML = '';
		document.getElementById('table-type').innerHTML = '';
		document.getElementById('table-price').innerHTML = '';
		document.getElementById('table-quantity').innerHTML = '';
		document.getElementById('table-weight').innerHTML = '';
		if(!cart_items || cart_items.length <= 0){
			if(mercadopagostatus !== 'approved' && mercadopagostatus !== 'pending'){
				document.getElementById('tables').style.display = 'none';
				document.getElementById('bag-state').src = 'img/bagempty.png';
				document.getElementById('shipping-total').remove();
				document.getElementById('buyermail').remove();
				document.getElementById('coupon').remove();
				document.getElementById('emailvalidator').remove();
				document.getElementById('grand-total').remove();
				document.getElementById('coupon-status').remove();
			}
		}
		else{
			document.getElementById('tables').style.display = 'block';
			document.getElementById('bag-state').src = 'img/bagfull.png';
			for(var i = 0; i < cart_items.length; ++i){
				var item = cart_items[i];
				//remove
				tr = document.createElement('tr');
				td = document.createElement('td');
				var img = document.createElement('img');
				img.src = 'img/bagdelete.png';
				img.classList.add('hoverable');
				img.onclick = removeFromCart;
				td.appendChild(img);
				tr.appendChild(td);
				document.getElementById('table-remove').appendChild(tr);
				//create preview
				var critterType = getCritterType(item);
				var jimg;
				var bgBoxSize = 50;
				var baseOffset = 10;
				switch(item.category){
					case categories.STUFFIE.CATEGORY:{
						//critter
						var jimg, jbody, jhead, jarm;
						var jimgprom = JimpCreate(300, 340).then(img => jimg = img);
						var bodyprom = Jimp.read(critters[critterType].BODY).then(img => jbody = img);
						var armprom = Jimp.read(critters[critterType].ARMS[item.variation]).then(img => jarm = img);
						var headprom = Jimp.read(critters[critterType].HEAD).then(img => jhead = img);
						await Promise.all([jimgprom, bodyprom, headprom, armprom]);
						//makes critter
						jimg.composite(jbody, baseOffset, baseOffset);
						if(item.accessory >= 0 && item.accessory < critters[critterType].ACCESSORIES.length){
							//load accessory
							var acc = critters[critterType].ACCESSORIES[item.accessory];
							var jacc = await Jimp.read(acc.IMG);
							//if arm is behind accessory
							if(!critters[critterType].ACCESSORIES[item.accessory].BEHIND_ARMS[item.variation]){
								if(item.variation === 2) //this arm is above face
									jimg.composite(jhead, baseOffset, baseOffset);
								jimg.composite(jarm, baseOffset, baseOffset);
								if(item.variation < 2) //this arm is below face
									jimg.composite(jhead, baseOffset, baseOffset);
								//accessory
								jimg.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
							}
							else{
								//arm above accessory
								if(item.variation === 2){ //this arm is above face
									jimg.composite(jhead, baseOffset, baseOffset);
									jimg.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
								}
								jimg.composite(jarm, baseOffset, baseOffset);
								if(item.variation < 2){ //this arm is below face
									jimg.composite(jhead, baseOffset, baseOffset);
									jimg.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
								}
							}
						}
						else{
							//there are no accessories
							if(item.variation === 2) //this arm is above face
								jimg.composite(jhead, baseOffset, baseOffset);
							jimg.composite(jarm, baseOffset, baseOffset);
							if(item.variation < 2) //this arm is below face
								jimg.composite(jhead, baseOffset, baseOffset);
						}
						jimg.autocrop();
						jimg.scaleToFit(bgBoxSize*0.8, bgBoxSize*0.8);

						break;
					}
					case categories.PIN.CATEGORY:{
						//critter
						var jimg, jcrit;
						var jimgprom = JimpCreate(300, 400).then(img => jimg = img);
						var imgprom = Jimp.read(critters[critterType].HEAD).then(img => jcrit = img);
						await Promise.all([jimgprom, imgprom]);
						if(item.accessory >= 0 && item.accessory < critters[critterType].ACCESSORIES.length){
							var acc = critters[critterType].ACCESSORIES[item.accessory];
							var jacc = await Jimp.read(acc.IMG);
							jcrit.composite(jacc, acc.POSX, acc.POSY);
						}
						//adds critter to preview
						jimg.composite(jcrit, baseOffset, baseOffset);
						jimg.autocrop();
						jimg.scaleToFit(bgBoxSize*0.65, bgBoxSize*0.65);

						break;
					}
					case categories.CHARM.CATEGORY:{
						//critter
						var jimg, jcrit, jbase, jbody, jhead, jarm;
						var baseprom = Jimp.read('img/charmbase.png').then(img => jbase = img);
						var jimgprom = JimpCreate(300, 340).then(img => jimg = img);
						var critprom = JimpCreate(300, 340).then(img => jcrit = img);
						var bodyprom = Jimp.read(critters[critterType].BODY).then(img => jbody = img);
						var armprom = Jimp.read(critters[critterType].ARMS[item.variation]).then(img => jarm = img);
						var headprom = Jimp.read(critters[critterType].HEAD).then(img => jhead = img);
						await Promise.all([jimgprom, critprom, baseprom, bodyprom, headprom, armprom]);
						//makes critter
						jcrit.composite(jbody, baseOffset, baseOffset);
						if(item.accessory >= 0 && item.accessory < critters[critterType].ACCESSORIES.length){
							//load accessory
							var acc = critters[critterType].ACCESSORIES[item.accessory];
							var jacc = await Jimp.read(acc.IMG);
							//if arm is behind accessory
							if(!critters[critterType].ACCESSORIES[item.accessory].BEHIND_ARMS[item.variation]){
								if(item.variation === 2) //this arm is above face
									jcrit.composite(jhead, baseOffset, baseOffset);
								jcrit.composite(jarm, baseOffset, baseOffset);
								if(item.variation < 2) //this arm is below face
									jcrit.composite(jhead, baseOffset, baseOffset);
								//accessory
								jcrit.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
							}
							else{
								//arm above accessory
								if(item.variation === 2){ //this arm is above face
									jcrit.composite(jhead, baseOffset, baseOffset);
									jcrit.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
								}
								jcrit.composite(jarm, baseOffset, baseOffset);
								if(item.variation < 2){ //this arm is below face
									jcrit.composite(jhead, baseOffset, baseOffset);
									jcrit.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
								}
							}
						}
						else{
							//there are no accessories
							if(item.variation === 2) //this arm is above face
								jcrit.composite(jhead, baseOffset, baseOffset);
							jcrit.composite(jarm, baseOffset, baseOffset);
							if(item.variation < 2) //this arm is below face
								jcrit.composite(jhead, baseOffset, baseOffset);
						}
						//adds critter to preview
						jbase.resize(Jimp.AUTO, categories.CHARM.PREVIEW.BASE.HEIGHT);
						jcrit.resize(Jimp.AUTO, categories.CHARM.PREVIEW.HEIGHT);
						jcrit.autocrop();
						jimg.composite(jbase, jimg.bitmap.width/2-jbase.bitmap.width/2, baseOffset);
						jimg.composite(jcrit, jimg.bitmap.width/2-jcrit.bitmap.width/2, baseOffset+jbase.bitmap.height-40);
						jimg.autocrop();
						jimg.scaleToFit(bgBoxSize*0.8, bgBoxSize*0.8);

						break;
					}
					case categories.EARRING.CATEGORY:{
						//critter
						var jimg, jbase, jcrit;
						var jimgprom = JimpCreate(300, 400).then(img => jimg = img);
						var baseprom = Jimp.read('img/earringbase.png').then(img => jbase = img);
						var imgprom = Jimp.read(critters[critterType].HEAD).then(img => jcrit = img);
						await Promise.all([jimgprom, baseprom, imgprom]);
						if(item.choker_accessory >= 0 && item.choker_accessory < critters[critterType].CHOKER_ACCESSORIES.length){
							var acc = critters[critterType].CHOKER_ACCESSORIES[item.choker_accessory];
							var jacc = await Jimp.read(acc.IMG);
							jcrit.composite(jacc, acc.POSX, acc.POSY);
						}
						//adds critter to preview
						jcrit.resize(Jimp.AUTO, categories.EARRING.PREVIEW.HEIGHT);
						jbase.resize(Jimp.AUTO, categories.EARRING.PREVIEW.BASE.HEIGHT);
						var offx1 = 10;
						jimg.composite(jbase, baseOffset+offx1, baseOffset);
						jimg.composite(jcrit, baseOffset+categories.EARRING.PREVIEW.LEFT-jcrit.bitmap.width/2, baseOffset+categories.EARRING.PREVIEW.TOP);
						var offx2 = 80;
						jimg.composite(jbase, baseOffset+offx2, baseOffset);
						jimg.composite(jcrit, baseOffset+offx2-offx1+categories.EARRING.PREVIEW.LEFT-jcrit.bitmap.width/2, baseOffset+categories.EARRING.PREVIEW.TOP);
						jimg.autocrop();
						jimg.scaleToFit(bgBoxSize*0.8, bgBoxSize*0.8);

						break;
					}
					case categories.CHOKER.CATEGORY:{
						//critter
						var jbase, jcrit;
						var jimgprom = JimpCreate(500, 500).then(img => jimg = img);
						var baseprom = Jimp.read(chokers[item.choker_variation]).then(img => jbase = img);
						var imgprom = Jimp.read(critters[critterType].HEAD).then(img => jcrit = img);
						await Promise.all([jimgprom, baseprom, imgprom]);
						if(item.choker_accessory >= 0 && item.choker_accessory < critters[critterType].CHOKER_ACCESSORIES.length){
							var acc = critters[critterType].CHOKER_ACCESSORIES[item.choker_accessory];
							var jacc = await Jimp.read(acc.IMG);
							jcrit.composite(jacc, acc.POSX, acc.POSY);
						}
						//adds critter to preview
						jcrit.resize(Jimp.AUTO, categories.CHOKER.PREVIEW.HEIGHT);
						jbase.resize(categories.CHOKER.PREVIEW.BASE.WIDTH, Jimp.AUTO);
						jimg.composite(jbase, jimg.bitmap.width/2-jbase.bitmap.width/2, 20);
						jimg.composite(jcrit, categories.CHOKER.PREVIEW.LEFT-jcrit.bitmap.width/2, categories.CHOKER.PREVIEW.TOP);
						jimg.autocrop();
						jimg.scaleToFit(bgBoxSize*0.8, bgBoxSize*0.8);

						break;
					}
					case categories.HEADBAND.CATEGORY:{
						//critter
						var jbase, jcrit;
						var headPath = (critters[critterType].HEAD.split('.')[0]+'_30o.png');
						var jimgprom = JimpCreate(500, 500).then(img => jimg = img);
						var baseprom = Jimp.read(headbands[item.headband_variation]).then(img => jbase = img);
						var imgprom = Jimp.read(headPath).then(img => jcrit = img);
						await Promise.all([jimgprom, baseprom, imgprom]);
						if(item.headband_accessory >= 0 && item.headband_accessory < critters[critterType].HEADBAND_ACCESSORIES.length){
							var acc = critters[critterType].HEADBAND_ACCESSORIES[item.headband_accessory];
							var accPath = (acc.IMG.split('.')[0]+'_30o.png');
							var jacc = await Jimp.read(accPath);
							jcrit.composite(jacc, acc.POSX, acc.POSY);
						}
						//adds critter to preview
						jcrit.resize(Jimp.AUTO, categories.HEADBAND.PREVIEW.HEIGHT);
						jbase.resize(categories.HEADBAND.PREVIEW.BASE.WIDTH, Jimp.AUTO);
						jimg.composite(jbase, jimg.bitmap.width/2-jbase.bitmap.width/2, 20);
						jimg.composite(jcrit, categories.HEADBAND.PREVIEW.LEFT-jcrit.bitmap.width/2, categories.HEADBAND.PREVIEW.TOP);
						jcrit.flip(true, false);
						jimg.composite(jcrit, categories.HEADBAND.PREVIEW.LEFT-jcrit.bitmap.width/2+categories.HEADBAND.PREVIEW.BASE.WIDTH-20, categories.HEADBAND.PREVIEW.TOP+5);
						jimg.autocrop();
						jimg.scaleToFit(bgBoxSize*0.8, bgBoxSize*0.8);

						break;
					}
					case categories.HAIRCLIP.CATEGORY:{
						//critter
						var jbase, jcrit;
						var jimgprom = JimpCreate(500, 500).then(img => jimg = img);
						var baseprom = Jimp.read(hairclips[item.hairclip_variation]).then(img => jbase = img);
						var imgprom = Jimp.read(critters[critterType].HEAD).then(img => jcrit = img);
						await Promise.all([jimgprom, baseprom, imgprom]);
						if(item.hairclip_accessory >= 0 && item.hairclip_accessory < critters[critterType].HAIRCLIP_ACCESSORIES.length){
							var acc = critters[critterType].HAIRCLIP_ACCESSORIES[item.hairclip_accessory];
							var jacc = await Jimp.read(acc.IMG);
							jcrit.composite(jacc, acc.POSX, acc.POSY);
						}
						//adds critter to preview
						jcrit.resize(Jimp.AUTO, categories.HAIRCLIP.PREVIEW.HEIGHT);
						jbase.resize(categories.HAIRCLIP.PREVIEW.BASE.WIDTH, Jimp.AUTO);
						jimg.composite(jbase, jimg.bitmap.width/2-jbase.bitmap.width/2, 20);
						jimg.composite(jcrit, categories.HAIRCLIP.PREVIEW.LEFT-jcrit.bitmap.width/2, categories.HAIRCLIP.PREVIEW.TOP);
						jimg.autocrop();
						jimg.scaleToFit(bgBoxSize*0.8, bgBoxSize*0.8);

						break;
					}
					case categories.MAGNET.CATEGORY:{
						//critter
						var jimg, jbody, jhead, jarm;
						var jimgprom = JimpCreate(300, 340).then(img => jimg = img);
						var bodyprom = Jimp.read(critters[critterType].BODY).then(img => jbody = img);
						var armprom = Jimp.read(critters[critterType].ARMS[item.variation]).then(img => jarm = img);
						var headprom = Jimp.read(critters[critterType].HEAD).then(img => jhead = img);
						await Promise.all([jimgprom, bodyprom, headprom, armprom]);
						//makes critter
						jimg.composite(jbody, baseOffset, baseOffset);
						if(item.accessory >= 0 && item.accessory < critters[critterType].ACCESSORIES.length){
							//load accessory
							var acc = critters[critterType].ACCESSORIES[item.accessory];
							var jacc = await Jimp.read(acc.IMG);
							//if arm is behind accessory
							if(!critters[critterType].ACCESSORIES[item.accessory].BEHIND_ARMS[item.variation]){
								if(item.variation === 2) //this arm is above face
									jimg.composite(jhead, baseOffset, baseOffset);
								jimg.composite(jarm, baseOffset, baseOffset);
								if(item.variation < 2) //this arm is below face
									jimg.composite(jhead, baseOffset, baseOffset);
								//accessory
								jimg.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
							}
							else{
								//arm above accessory
								if(item.variation === 2){ //this arm is above face
									jimg.composite(jhead, baseOffset, baseOffset);
									jimg.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
								}
								jimg.composite(jarm, baseOffset, baseOffset);
								if(item.variation < 2){ //this arm is below face
									jimg.composite(jhead, baseOffset, baseOffset);
									jimg.composite(jacc, baseOffset+acc.POSX, baseOffset+acc.POSY);
								}
							}
						}
						else{
							//there are no accessories
							if(item.variation === 2) //this arm is above face
								jimg.composite(jhead, baseOffset, baseOffset);
							jimg.composite(jarm, baseOffset, baseOffset);
							if(item.variation < 2) //this arm is below face
								jimg.composite(jhead, baseOffset, baseOffset);
						}
						jimg.autocrop();
						jimg.scaleToFit(bgBoxSize*0.8, bgBoxSize*0.8);

						break;
					}
					case categories.MINIPIN.CATEGORY:{
						//critter
						var jcrit;
						var jimgprom = JimpCreate(500, 500).then(img => jimg = img);
						var imgprom = Jimp.read(critters[critterType].HEAD).then(img => jcrit = img);
						await Promise.all([jimgprom, imgprom]);
						if(item.hairclip_accessory >= 0 && item.hairclip_accessory < critters[critterType].HAIRCLIP_ACCESSORIES.length){
							var acc = critters[critterType].HAIRCLIP_ACCESSORIES[item.hairclip_accessory];
							var jacc = await Jimp.read(acc.IMG);
							jcrit.composite(jacc, acc.POSX, acc.POSY);
						}
						//adds critter to preview
						jcrit.resize(Jimp.AUTO, categories.MINIPIN.PREVIEW.HEIGHT);
						jimg.composite(jcrit, jimg.bitmap.width/2-jcrit.bitmap.width/2, 20);
						jimg.autocrop();
						jimg.scaleToFit(bgBoxSize*0.8, bgBoxSize*0.8);

						break;
					}
				}
				//applies bg and converts to base64
				var bg = await Jimp.read('img/bagbox.png');
				bg.composite(jimg, bg.bitmap.width/2-jimg.bitmap.width/2, (bg.bitmap.height-jimg.bitmap.height)/2);
				bg.getBase64Async(Jimp.MIME_PNG)
				.then(bg64 =>{
					tr = document.createElement('tr');
					td = document.createElement('td');
					img = document.createElement('img');
					img.src = bg64;
					img.name = 'item-preview';
					td.appendChild(img);
					tr.appendChild(td);
					document.getElementById('table-preview').appendChild(tr);
				});
				//type
				tr = document.createElement('tr');
				td = document.createElement('td');
				td.innerHTML = item.category;
				tr.appendChild(td);
				document.getElementById('table-type').appendChild(tr);
				//price
				tr = document.createElement('tr');
				td = document.createElement('td');
				td.innerHTML = (loadedMercadopagoSdk?'R':'')+'$'+getItemPrice(item.category);
				tr.appendChild(td);
				document.getElementById('table-price').appendChild(tr);
				//quantity
				tr = document.createElement('tr');
				td = document.createElement('td');
				td.innerHTML = 1;
				tr.appendChild(td);
				document.getElementById('table-quantity').appendChild(tr);
				//weight
				tr = document.createElement('tr');
				td = document.createElement('td');
				var w = getItemWeight(item.category);
				if(!isNaN(w) && isFinite(w)){
					td.innerHTML = w+'g';
					totalWeight += w;
				}
				tr.appendChild(td);
				document.getElementById('table-weight').appendChild(tr);
			}
			//total weight
			tr = document.createElement('tr');
			td = document.createElement('td');
			td.innerHTML = '<b>total weight :</b>';
			tr.appendChild(td);
			document.getElementById('table-quantity').appendChild(tr);
			tr = document.createElement('tr');
			td = document.createElement('td');
			td.innerHTML = '<b>'+totalWeight+'g</b>';
			tr.appendChild(td);
			document.getElementById('table-weight').appendChild(tr);
			//sets final price
			await calculateFinalPrice();
		}
	}

	function clearCart(){
		if(environment !== 'development'){
			setCookie("cart_items", JSON.stringify([]));
			deleteCookie("cart_items");
		}
	}

	//load cart from cookies
	async function loadCart(){
		if(!loadingSomething && (loadedMercadopagoSdk || loadedPaypalSdk)){
			var cartCookie = getCookie("cart_items");
			if(cartCookie){
				var cart = JSON.parse(cartCookie);
				if(Array.isArray(cart) && cart.length > 0){
					cart_items = cart;
				}
			}
			await updateCart();
		}
		else{
			setTimeout(loadCart, 50);
		}
	}

	var oldCouponCode = '';
	var appliedDiscount = 0;
	async function checkCoupon(){
		var couponEl = document.getElementById('coupon');
		var code = couponEl.value;
		var statusEl = document.getElementById('coupon-status');
		if(code){
			oldCouponCode = code;
			var req = await fetch(api_path+'/coupon?code='+code, {method: 'GET'});
			var res = await req.json();
			if(res && !isNaN(res) && res > 0){
				statusEl.style.display = 'block';
				statusEl.src = 'img/couponok.png';
				appliedDiscount = res;
			}
			else{
				statusEl.style.display = 'block';
				statusEl.src = 'img/couponwrong.png';
				appliedDiscount = 0;
			}
		}
		else if(oldCouponCode){
			statusEl.style.display = 'block';
			statusEl.src = 'img/couponwrong.png';
			appliedDiscount = 0;
		}
		await calculateFinalPrice();
	}
</script>

<img style="position: absolute;
	left: 340px;
	top: 20px;
overflow-y:hidden;
overflow-x:hidden;
z-index: 1;" src="./img/shoppingbag.png">

<a href="/policies">
<img style="position: absolute;
	left: 350px;
	top: 450px;
overflow-y:hidden;
overflow-x:hidden;
z-index: 2;" src="./img/privacybutton.png"></a>

<a href="/">
<img style="position: absolute;
	left: 365px;
	top: 485px;
overflow-y:hidden;
overflow-x:hidden;
z-index: 2;" src="./img/homeleft.png"></a>

<a>
<img style="position: absolute;
	left: 815px;
	top: 380px;
overflow-y:hidden;
overflow-x:hidden;
z-index: 2;" src="./img/digital-button.png" onclick="openDigitalConfirmation();"></a>

<img id="bag-state" style="position: absolute;
	left: 475px;
	top: 165px;
overflow-y:hidden;
overflow-x:hidden;
z-index: 2;" src="./img/bagfull.png">

<div id="tables" style="position: absolute; left: 450px; top: 190px;
overflow: auto; overflow: scroll; z-index: 5; width:370px; height:175px;
background: transparent; resize: none; outline:none;
border: 0px; color: #917979; font-family: Calibri;
font-size: 11px; letter-spacing:1px; line-height:20px;">

<div style="position: absolute; left:10px; right:10px;">
	<div style="display: flex;">
		<table id="table-remove" style="position: relative;"></table>
		<table id="table-preview" style="position: relative;"></table>
		<table id="table-type" style="position: relative;"></table>
		<table id="table-quantity" style="position: relative;"></table>
		<table id="table-price" style="position: relative; left: 10px;"></table>
		<table id="table-weight" style="position: relative; left: 55px;"></table>
	</div>
</div>

</div>

<p id="shipping-total" style="font-size: 10pt; font-weight: bold; text-align: right; position: absolute; top: 350px; left: 625px; z-index: 20;"></p>
<p id="grand-total" style="font-size: 11pt; font-weight: bold; text-align: right; position: absolute; top: 475px; left: 530px; z-index: 20;"></p>

<style>
::placeholder { color:#bda4a4; opacity: 1; }
::-ms-input-placeholder { color:#bda4a4; opacity: 1; }
</style>

<input id="buyermail" maxlength="50" style="position: absolute; left: 620px; top: 413px;
overflow: hidden; z-index: 5; width: 155px; height:20px;
background: transparent; resize: none; padding:5px; outline:none;
border: 0px; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;" oninput="validateEmail(this.value);"></input>

<img id="emailvalidator" style="display: none; z-index: 20; position: absolute; top: 420px; left: 785px;">

<input id="coupon" maxlength="8" style="position: absolute; left: 638px; top: 456px;
overflow: hidden; z-index: 5; width: 65px; height:20px;
background: transparent; resize: none; padding:5px; outline:none;
border: 0px; cursor: url(./img/cursorwrite.png), progress; color: #fff; font-family: Calibri;
font-size: 11px; letter-spacing:1px; line-height:15px; font-weight:bold;" onblur="checkCoupon();"></input>

<img id="coupon-status" style="display: none; z-index: 20; position: absolute; top: 458px; left: 715px;">

<img id="bag-total" style="position: absolute;
	left: 475px;
	top: 410px;
overflow-y:hidden;
overflow-x:hidden;
z-index: 2;" src="./img/bagtotal.png">

<img id="notebag" src="./img/notebag.png" style="position: absolute; z-index: 2; top: 565px; left: 685px;">

<!-- Add the checkout buttons, set up the order and approve the order -->
<img src="./img/filladdress.png" onclick="openAddressForm();" class="hoverable" id="paypal-filladdress" style="position: absolute; z-index: 4; top: 529px; left: 489px;">
<div id="paypal-payment-methods" style="display: none;">
	<img src="./img/checkoutback.png" style="position: absolute; z-index: 2; top: 525px; left: 485px;">
	<img src="./img/checkoutpaypal.png" style="pointer-events: none; position: absolute; z-index: 4; top: 529px; left: 489px;">
	<img src="./img/checkoutcredit.png" style="pointer-events: none; position: absolute; z-index: 4; top: 574px; left: 489px;">
</div>
<div id="paypal-container" style="z-index: 3; width: 175px; position: absolute; top: 530px; left: 490px;">
	<div class="hoverable" id="paypal-button-container"></div>
	<div class="hoverable" id="card-button-container" style="margin-top: 5px;"></div>
</div>
<div id="mercadopago-container" style="display: none;">
	<a><img src="./img/brazilcheckout.png" id="mercadopago-button" onclick="openAddressForm();" style="position: absolute; z-index: 4; top: 529px; left: 489px;"></a>
</div>
<script>
	function setPaypalButtonsVisibility(visible){
		if(visible){
			document.getElementById('paypal-payment-methods').style.display = 'block';
			document.getElementById('paypal-filladdress').style.display = 'none';
		}
		else{
			document.getElementById('paypal-payment-methods').style.display = 'none';
			document.getElementById('paypal-button-container').innerHTML = '';
			document.getElementById('card-button-container').innerHTML = '';
			document.getElementById('paypal-filladdress').style.display = 'block';
		}
	}
	setPaypalButtonsVisibility(false);

	var paypalButtons = [];
	var buyerCardRestricted = false;
	function loadPaypalButtons(){
		if(loadedPaypalSdk){
			var FUNDING_SOURCES = [
				paypal.FUNDING.PAYPAL
			];
			//check buyer country to determine available payment
			var cardRestrictedCountries = ['BR', 'JP', 'RU'];
			buyerCardRestricted = cardRestrictedCountries.includes(buyerCountry);
			if(!buyerCardRestricted){
				//enable card payment
				FUNDING_SOURCES.push(paypal.FUNDING.CARD);
			}
			//restricted
			else{
				var el = $(`<img src="./img/jprussiacheckout.png" style="pointer-events: none; position: absolute; z-index: 4; top: 524px; left: 485px;">`);
				$('#paypal-payment-methods').empty().append(el);
				$('#notebag')[0].src = './img/jprussianotebag.png';
			}

			// Loop over each funding source/payment method
			FUNDING_SOURCES.forEach(function(fundingSource) {
				// Initialize the buttons
				var divContainer = fundingSource === paypal.FUNDING.PAYPAL?'#paypal-button-container':'#card-button-container';
				var button = paypal.Buttons({
					fundingSource: fundingSource,
					style:{
						tagline: false,
						height: 40
					},
					createOrder: async function (data, actions) {
						var catcart = [];
						cart_items.forEach(item =>{
							catcart.push(item.category);
						});
						var code = document.getElementById('coupon').value;
						var priceFetch = await fetch(api_path+'/order/price', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								cart: catcart,
								coupon: code,
								affiliate: getQueryParam(affiliateParam)
							})
						});
						var resp = await priceFetch.json();
						updatedPrice = resp.price.price;
						var convReq = await fetch(api_path+'/currency/conversion?amt='+updatedPrice, {method: 'GET'});
						var convRes = await convReq.json();
						var currency = convRes.currency;
						var finalValue = convRes.amount;
						return actions.order.create({
							purchase_units: [{
								amount: {
									value: finalValue,
									currency_code: currency
								}
							}]
						});
					},
					onCancel: function(){
						setPaypalButtonsVisibility(false);
					},
					onApprove: function (data, actions) {
						return actions.order.capture().then(async function (details) {
							var buyerMailEl = document.getElementById('buyermail');
							var buyerMail = buyerMailEl.value;
							var couponEl = document.getElementById('coupon');
							var usedCoupon = couponEl.value;
							var previews = document.getElementsByName('item-preview');
							var formData = JSON.stringify({
								orderId: details.id,
								buyerMail: buyerMail,
								coupon: usedCoupon,
								affiliate: getQueryParam(affiliateParam),
								items: cart_items,
								address: {
									name: addressName,
									addr1: addressAddr1,
									addr2: addressAddr2,
									city: addressCity,
									state: addressState,
									zip: addressZip,
									country: addressCountry
								}
							});

							//change page layout
							document.getElementById('tables').style.display = 'none';
							document.getElementById('bag-state').src = 'img/bagdone.png';
							document.getElementById('shipping-total').remove();
							document.getElementById('buyermail').remove();
							document.getElementById('coupon').remove();
							document.getElementById('emailvalidator').remove();
							document.getElementById('grand-total').remove();
							document.getElementById('coupon-status').remove();

							return fetch(api_path+'/order', {
								method: 'POST',
								cache: 'no-cache',
								headers:{
									'Content-Type': 'application/json'
								},
								body: formData
							}).then(()=>{
								clearCart();
								paypalButtons.forEach(btn => btn.close());
							});
						});
					},
					onError: function(err){
						location.reload();
					}
				});
				// Check if the button is eligible
				if(button.isEligible()){
					// Render the standalone button for that funding source
					paypalButtons.push(button);
					button.render(divContainer);
				}
			});
		}
		else if(!loadedMercadopagoSdk){
			//await paypal sdk to load, if needed
			setTimeout(loadPaypalButtons, 50);
		}
	}
	
	var mercadopago;
	var mercadopagoCheckout;
	var mercadopagostatus = getQueryParam('mercadopago_status');
	function loadMercadopagoButtons(){
		if(loadedMercadopagoSdk){
			//hide paypal containers and show mercadopago
			document.getElementById('paypal-payment-methods').style.display = 'none';
			document.getElementById('paypal-container').style.display = 'none';
			document.getElementById('mercadopago-container').style.display = 'block';
			document.getElementById('mercadopago-button').style.display = 'block';
			document.getElementById('notebag').src = './img/brazilnotebag.png';

			//check if came redirected from mercadopago
			if(mercadopagostatus === 'approved' || mercadopagostatus === 'pending'){
				clearCart();
				//show 'done' message
				document.getElementById('tables').style.display = 'none';
				document.getElementById('bag-state').src = 'img/bagdone.png';
				document.getElementById('shipping-total').remove();
				document.getElementById('buyermail').remove();
				document.getElementById('coupon').remove();
				document.getElementById('emailvalidator').remove();
				document.getElementById('grand-total').remove();
				document.getElementById('coupon-status').remove();
			}

			mercadopago = new MercadoPago(mercadopagoKey, {
				locale: 'pt-BR'
			});
		}
		else if(!loadedPaypalSdk){
			//await paypal sdk to load, if needed
			setTimeout(loadMercadopagoButtons, 10);
		}
	}
	async function openMercadopago(){
		
		showLoadingOverlay();

		//parse cart
		var catcart = [];
		cart_items.forEach(item =>{
			catcart.push(item.category);
		});
		var name = document.getElementById('addressform-name').value;
		var street = document.getElementById('addressform-street').value;
		var number = document.getElementById('addressform-number').value;
		var compl = document.getElementById('addressform-compl').value;
		var city = document.getElementById('addressform-city').value;
		var state = document.getElementById('addressform-state').value;
		var cep = document.getElementById('addressform-cep').value;
		//init checkout
		var prefId;
		try{
			var req = await fetch(api_path+'/order/mercadopago/preference/create',{
				method: 'POST',
				headers:{
					'content-type': 'application/json'
				},
				body: JSON.stringify({
					cart: catcart,
					rawcart: cart_items,
					address:{
						name: name,
						street: street,
						number: number,
						compl: compl,
						city: city,
						state: state,
						cep: cep
					},
					email: document.getElementById('buyermail').value,
					coupon: document.getElementById('coupon').value,
					affiliate: getQueryParam(affiliateParam)
				})
			});
			if(req.status === 200){
				var body = await req.json();
				prefId = body.preference;
			}
			//create and open checkout
			mercadopagoCheckout = await mercadopago.checkout({
				preference:{
					id: prefId
				}
			});
			mercadopagoCheckout.open();
		}
		catch(err){
			console.log(err);
		}
		hideLoadingOverlay();
	}
	
	var addressName = '';
	var addressAddr1 = '';
	var addressAddr2 = '';
	var addressCity = '';
	var addressState = '';
	var addressZip = '';
	var addressCountry = '';
	function openAddressForm(){
		if(cartIsEmpty()){
			return false;
		}
		//validate buyer email
		var buyerMailEl = document.getElementById('buyermail');
		var buyerMail = buyerMailEl.value;
		if(!validateEmail(buyerMail)){
			buyerMailEl.value = '';
			return false;
		}
		//show address form
		var addressFormOverlay = $.parseHTML(`<div id="addressFormOverlay"
		style="position:fixed; display:flex; justify-content:center; align-items:center; width:100%;
		height:100%; top: 0; left: 0; background:#fff; opacity:0.3; z-index:999997">`);
		$(addressFormOverlay).insertAfter('head');
		var addressFormFields = '';
		if(loadedPaypalSdk){
			addressFormFields = $.parseHTML(`
			<div id="addressForm">
				<img id="addressform" style="position: absolute; left: 500px; top: 190px; overflow-y:hidden; overflow-x:hidden; z-index: 999998;" src="./img/address.png">
				
				<input id="addressform-name" onblur="addressName = this.value;" style="position: absolute; left: 540px; top: 232px;
				overflow: hidden; z-index: 999999; width: 190px; height:20px;
				border: 0px; outline:none; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px;"></input>

				<input id="addressform-addr1" onblur="addressAddr1 = this.value;" style="position: absolute; left: 540px; top: 275px;
				overflow: hidden; z-index: 999999; width: 190px; height:20px;
				border: 0px; outline:none; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px;"></input>

				<input id="addressform-addr2" onblur="addressAddr2 = this.value;" style="position: absolute; left: 540px; top: 320px;
				overflow: hidden; z-index: 999999; width: 190px; height:20px;
				border: 0px; outline:none; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px;"></input>

				<input id="addressform-city" onblur="addressCity = this.value;" style="position: absolute; left: 540px; top: 365px;
				overflow: hidden; z-index: 999999; width: 190px; height:20px;
				border: 0px; outline:none; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px;"></input>

				<input id="addressform-state" onblur="addressState = this.value;" style="position: absolute; left: 540px; top: 410px;
				overflow: hidden; z-index: 999999; width: 95px; height:20px;
				border: 0px; outline:none; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px;"></input>

				<input id="addressform-zip" onblur="addressZip = this.value;" inputmode="numeric" pattern="\d*" style="position: absolute; left: 540px; top: 452px;
				overflow: hidden; z-index: 999999; width: 95px; height:20px;
				border: 0px; outline:none; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px;"></input>

				<input id="addressform-country" onblur="addressCountry = this.value;" style="position: absolute; left: 540px; top: 495px;
				overflow: hidden; z-index: 999999; width: 100px; height:20px;
				border: 0px; outline:none; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px;"></input>

				<a><img src="./img/bagdelete.png" style="z-index: 999999; position: absolute; left: 715px; top: 197px;" onclick="closeAddressForm();"></a>
				<a><img src="./img/ok-address.png" style="z-index: 999999; position: absolute; left: 660px; top: 410px;" onclick="confirmAddressForm();"></a>
			</div>`);

			$('#everything').append(addressFormFields);

			document.getElementById('addressform-name').value = addressName;
			document.getElementById('addressform-addr1').value = addressAddr1;
			document.getElementById('addressform-addr2').value = addressAddr2;
			document.getElementById('addressform-city').value = addressCity;
			document.getElementById('addressform-state').value = addressState;
			document.getElementById('addressform-zip').value = addressZip;
			document.getElementById('addressform-country').value = addressCountry;
		}
		else{
			addressFormFields = $.parseHTML(`
			<div id="addressForm">
				<img id="addressform" style="position: absolute; left: 500px; top: 190px; overflow-y:hidden; overflow-x:hidden; z-index: 999998;" src="./img/address-brazil.png">
				
				<input id="addressform-name" style="position: absolute; left: 540px; top: 242px;
				overflow: hidden; z-index: 999999; width: 190px; height:20px;
				border: 0px; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px; outline:none;"></input>

				<input id="addressform-street" style="position: absolute; left: 540px; top: 285px;
				overflow: hidden; z-index: 999999; width: 190px; height:20px;
				border: 0px; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px; outline:none;"></input>

				<input id="addressform-number" style="position: absolute; left: 540px; top: 330px;
				overflow: hidden; z-index: 999999; width: 80px; height:20px;
				border: 0px; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px; outline:none;"></input>

				<input id="addressform-compl" style="position: absolute; left: 645px; top: 330px;
				overflow: hidden; z-index: 999999; width: 80px; height:20px;
				border: 0px; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px; outline:none;"></input>

				<input id="addressform-city" style="position: absolute; left: 540px; top: 375px;
				overflow: hidden; z-index: 999999; width: 190px; height:20px;
				border: 0px; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px; outline:none;"></input>

				<input id="addressform-state" style="position: absolute; left: 540px; top: 420px;
				overflow: hidden; z-index: 999999; width: 95px; height:20px;
				border: 0px; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px; outline:none;"></input>

				<input id="addressform-cep" inputmode="numeric" pattern="\d*" style="position: absolute; left: 540px; top: 462px;
				overflow: hidden; z-index: 999999; width: 95px; height:20px;
				border: 0px; cursor: url(./img/cursorwrite.png), progress; font-family: Calibri;
				font-size: 11px; color:#998585; letter-spacing:1px; line-height:15px; font-weight:bold;
				background: transparent; resize: none; padding:5px; outline:none;"></input>

				<a><img src="./img/bagdelete.png" style="z-index: 999999; position: absolute; left: 715px; top: 197px;" onclick="closeAddressForm();"></a>
				<a><img src="./img/ok-address.png" style="z-index: 999999; position: absolute; left: 660px; top: 410px;" onclick="confirmAddressForm();"></a>
			</div>`);

			$('#everything').append(addressFormFields);
		}
	}
	function confirmAddressForm(){
		if(loadedPaypalSdk){
			var name = document.getElementById('addressform-name');
			var addr1 = document.getElementById('addressform-addr1');
			var city = document.getElementById('addressform-city');
			var state = document.getElementById('addressform-state');
			var zip = document.getElementById('addressform-zip');
			if(!name.value){
				name.placeholder = 'invalid name';
				return false;
			}
			if(!addr1.value){
				addr1.placeholder = 'invalid address';
				return false;
			}
			if(!city.value){
				city.placeholder = 'invalid city';
				return false;
			}
			if(!state.value){
				state.placeholder = 'invalid state/province';
				return false;
			}
			if(!zip.value){
				zip.value = '';
				zip.placeholder = 'invalid zip code';
				return false;
			}
			closeAddressForm();
			setPaypalButtonsVisibility(true);
			loadPaypalButtons();
		}
		else{
			var name = document.getElementById('addressform-name');
			var street = document.getElementById('addressform-street');
			var number = document.getElementById('addressform-number');
			var city = document.getElementById('addressform-city');
			var state = document.getElementById('addressform-state');
			var cep = document.getElementById('addressform-cep');
			if(!name.value){
				name.placeholder = 'insira um nome';
				return false;
			}
			if(!street.value){
				street.placeholder = 'insira uma rua';
				return false;
			}
			if(!validateInt(number.value)){
				number.value = '';
				number.placeholder = 'insira um número válido';
				return false;
			}
			if(!city.value){
				city.placeholder = 'insira uma cidade';
				return false;
			}
			if(!state.value){
				state.placeholder = 'insira um estado';
				return false;
			}
			if(!validateCep(cep.value)){
				cep.value = '';
				cep.placeholder = 'insira um CEP válido';
				return false;
			}
			openMercadopago();
		}
	}
	function closeAddressForm(){
		$('#addressForm').remove();
		$('#addressFormOverlay').remove();
	}

	//loadPaypalButtons();
	loadMercadopagoButtons();
</script>

<script>loadCart();</script>

</div>
</body>

<!--

　　　          ___   .--.
　　　    .--.-"   "-' .- |
　　　   / .-,`          .'   
　　　   \   `           \ 　　　　　　。・゜ 　♡   。　　・　゜ 　　　♡  
　　　    '.            ・ \　　　　　　　　　　　　　　　　　　　　　　　　♡　　　　♡ ゜・。。♡  
　　　      |  ・     ᴥ    。|　　　　・゜♡ ゜・。　　. * ・ ♡ °  . 。
　　　      \ 。            /.____　　　　　　　　　　　　　　　　　　♡.  
　　　     /`-.          ,'.'    `\　　　　　　　　　　　　　　　　　　。・゜　　　 ♡ ・ 。　　。・゜ ♡  
　　　  __/   \`-.____.-' `\      /　　　　　♡　。・゜      
　　　  | `---`'-'._/-`     \----'    _ 　　　　　　　　　　　♡　　　.　　　.♡ 
　　　  |,-'`  /             |    _.-' `\　　　　. * ・        
　　　 .'     /              |--'`     / |　　　　　　　　　　 ♡
　　　/      /\              `         | |
　　　|   .\/  \      .--. __          \ |　　　　　　　　　　　*.。middlepot.com 
　　　 '-'      '._       /  `\         /　　　　　　　　　　　　　　　　　　　　　　　ଘ(*´ ˘ `*)ഒ 。.*
　　　             `\    '     |------'`
　　　               \  |      |
　　　                \        /
 　　　                '._  _.'

-->

</html>